name: Update PR Changelog

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to regenerate changelog for"
        required: true
        type: number
      force_update:
        description: "Force update even if no version change detected"
        required: false
        type: boolean
        default: false

jobs:
  regenerate-changelog:
    runs-on: ubuntu-latest

    steps:
      - name: Get PR information
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};

            // è·å– PR ä¿¡æ¯
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            if (pr.state !== 'open') {
              core.setFailed(`PR #${prNumber} is ${pr.state}, can only update open PRs`);
              return;
            }

            core.setOutput('pr-number', prNumber);
            core.setOutput('pr-body', pr.body || '');
            core.setOutput('head-ref', pr.head.ref);
            core.setOutput('head-sha', pr.head.sha);
            core.setOutput('base-ref', pr.base.ref);

            return {
              prNumber,
              prBody: pr.body || '',
              headRef: pr.head.ref,
              headSha: pr.head.sha,
              baseRef: pr.base.ref
            };

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-info.outputs.head-ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if package.json version changed
        id: version-check
        run: |
          # è·å–å½“å‰åˆ†æ”¯çš„ package.json ç‰ˆæœ¬
          if [ -f package.json ]; then
            CURRENT_VERSION=$(jq -r .version package.json)
          else
            echo "package.json not found"
            if [ "${{ inputs.force_update }}" = "true" ]; then
              echo "Force update enabled, continuing without version check"
              echo "version-changed=true" >> $GITHUB_OUTPUT
              echo "new-version=unknown" >> $GITHUB_OUTPUT
              echo "previous-version=unknown" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "version-changed=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # è·å– base åˆ†æ”¯çš„ package.json ç‰ˆæœ¬è¿›è¡Œæ¯”è¾ƒ
          BASE_REF="${{ steps.pr-info.outputs.base-ref }}"
          git fetch origin $BASE_REF:$BASE_REF
          git show $BASE_REF:package.json > base_package.json 2>/dev/null || echo '{"version": "0.0.0"}' > base_package.json
          BASE_VERSION=$(jq -r .version base_package.json)

          echo "Base branch ($BASE_REF) version: $BASE_VERSION"
          echo "Current branch version: $CURRENT_VERSION"

          # æ£€æŸ¥ç‰ˆæœ¬æ˜¯å¦å‘ç”Ÿå˜åŒ–æˆ–å¼ºåˆ¶æ›´æ–°
          if [ "$CURRENT_VERSION" != "$BASE_VERSION" ] || [ "${{ inputs.force_update }}" = "true" ]; then
            echo "Version changed from $BASE_VERSION to $CURRENT_VERSION (or force update enabled)"
            echo "version-changed=true" >> $GITHUB_OUTPUT
            echo "new-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
            echo "previous-version=$BASE_VERSION" >> $GITHUB_OUTPUT
          else
            echo "Version not changed and force update not enabled"
            echo "version-changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog from PR description
        id: extract-changelog
        if: steps.version-check.outputs.version-changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = `${{ steps.pr-info.outputs.pr-body }}`;
            const prNumber = '${{ steps.pr-info.outputs.pr-number }}';
            const newVersion = '${{ steps.version-check.outputs.new-version }}';

            console.log('PR Body:', prBody);

            // æŸ¥æ‰¾ ## Changelog æˆ– ## æ›´æ–°æ—¥å¿— éƒ¨åˆ†
            const changelogRegex = /(?:^|\n)##\s*(?:Changelog|æ›´æ–°æ—¥å¿—|CHANGELOG)\s*\n([\s\S]*?)(?=\n##|\n---|\n```|$)/i;
            const match = prBody.match(changelogRegex);

            let changelog = '';
            if (match && match[1]) {
              changelog = match[1].trim();
              // æ¸…ç†æ³¨é‡Šå†…å®¹
              changelog = changelog.replace(/<!--[\s\S]*?-->/g, '').trim();
              // æ¸…ç†ç©ºè¡Œ
              changelog = changelog.replace(/\n\s*\n\s*\n/g, '\n\n');
              console.log('Changelog after removing comments:', changelog);
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ˜ç¡®çš„ changelog éƒ¨åˆ†ï¼Œä¸è¿›è¡Œå®½æ³›çš„å…³é”®è¯åŒ¹é…
            // è¿™æ ·å¯ä»¥é¿å…æ„å¤–æå–æ¨¡æ¿ã€ç¤ºä¾‹æˆ–æ— å…³å†…å®¹

            // æ£€æŸ¥æå–çš„å†…å®¹æ˜¯å¦åŒ…å«æ¨¡æ¿æˆ–ç¤ºä¾‹å†…å®¹
            if (changelog && changelog.trim() !== '') {
              const templateKeywords = [
                'If this PR requires a new version',
                'å¦‚æœè¿™ä¸ª PR éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬',
                'please write the changelog below',
                'è¯·åœ¨ä¸‹é¢å†™æ˜æ›´æ–°æ—¥å¿—',
                'Suggested format',
                'æ ¼å¼å»ºè®®',
                'Example / ç¤ºä¾‹',
                'batch file copy functionality',
                'Added keyboard shortcut',
                'Fixed performance issues',
                'lower the minimum supported version',
                'CHANGELOG generation',
                'templates for changelog entries',
                'enhance log statement insertion'
              ];
              
              const isTemplate = templateKeywords.some(keyword => 
                changelog.toLowerCase().includes(keyword.toLowerCase())
              );
              
              if (isTemplate) {
                console.log('Detected template or example content, treating as empty');
                changelog = '';
              }
            }

            // å¦‚æœæ²¡æœ‰æ‰¾åˆ° changelog æˆ–å†…å®¹ä¸ºç©ºï¼Œç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„
            if (!changelog) {
              changelog = `### Changed / å˜æ›´
            - Release v${newVersion}
            - å‘å¸ƒ v${newVersion} ç‰ˆæœ¬

            Changes merged from PR #${prNumber}
            åˆå¹¶æ¥è‡ª PR #${prNumber} çš„æ›´æ”¹`;
            }

            console.log('Final changelog:', changelog);

            // ä¿å­˜åˆ°æ–‡ä»¶
            const fs = require('fs');
            fs.writeFileSync('extracted-changelog.txt', changelog);

            return { changelog: changelog };

      - name: Remove existing changelog commits
        if: steps.version-check.outputs.version-changed == 'true'
        run: |
          NEW_VERSION="${{ steps.version-check.outputs.new-version }}"

          # æŸ¥æ‰¾å¹¶åˆ é™¤ç°æœ‰çš„ changelog æäº¤
          echo "Looking for existing changelog commits for version $NEW_VERSION"

          # è·å–æœ€è¿‘çš„ 10 ä¸ªæäº¤ï¼ŒæŸ¥æ‰¾ changelog ç›¸å…³çš„æäº¤
          CHANGELOG_COMMITS=$(git log --oneline -10 --grep="docs: update CHANGELOG.md for v$NEW_VERSION" --format="%H")

          if [ -n "$CHANGELOG_COMMITS" ]; then
            echo "Found existing changelog commits, removing them:"
            echo "$CHANGELOG_COMMITS"
            
            # è®¡ç®—éœ€è¦é‡ç½®åˆ°çš„æäº¤ï¼ˆæœ€æ—©çš„ changelog æäº¤çš„çˆ¶æäº¤ï¼‰
            OLDEST_CHANGELOG_COMMIT=$(echo "$CHANGELOG_COMMITS" | tail -n 1)
            RESET_TO_COMMIT=$(git rev-parse "$OLDEST_CHANGELOG_COMMIT^")
            
            echo "Resetting to commit: $RESET_TO_COMMIT"
            git reset --hard "$RESET_TO_COMMIT"
          else
            echo "No existing changelog commits found"
          fi

      - name: Update CHANGELOG.md
        if: steps.version-check.outputs.version-changed == 'true'
        run: |
          # è¯»å–ç‰ˆæœ¬å’Œæ›´æ–°æ—¥å¿—
          NEW_VERSION="${{ steps.version-check.outputs.new-version }}"
          CHANGELOG_CONTENT=$(cat extracted-changelog.txt)
          CURRENT_DATE=$(date +"%Y-%m-%d")

          echo "Updating CHANGELOG.md for version $NEW_VERSION"
          echo "Changelog content:"
          echo "$CHANGELOG_CONTENT"

          # åˆ›å»ºæ–°çš„ changelog æ¡ç›®
          cat > new_changelog_entry.md << EOF
          ## [$NEW_VERSION] - $CURRENT_DATE

          $CHANGELOG_CONTENT

          EOF

          # æ›´æ–° CHANGELOG.md
          if [ -f CHANGELOG.md ]; then
            echo "CHANGELOG.md exists, updating it"
            
            # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰è¿™ä¸ªç‰ˆæœ¬çš„æ¡ç›®ï¼Œå¦‚æœæœ‰åˆ™è·³è¿‡ä»¥é¿å…é‡å¤
            if grep -q "^## \[$NEW_VERSION\]" CHANGELOG.md; then
              echo "Version $NEW_VERSION already exists in CHANGELOG.md, skipping update to avoid duplication"
            else
              echo "Adding new entry for version $NEW_VERSION to CHANGELOG.md"
              # æ™ºèƒ½æ’å…¥ - æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç‰ˆæœ¬æ¡ç›®çš„ä½ç½®
              FIRST_VERSION_LINE=$(grep -n "^## \[" CHANGELOG.md | head -1 | cut -d: -f1)
              if [ -n "$FIRST_VERSION_LINE" ] && [ "$FIRST_VERSION_LINE" -gt 1 ]; then
                # åœ¨ç¬¬ä¸€ä¸ªç‰ˆæœ¬æ¡ç›®ä¹‹å‰æ’å…¥
                head -n $((FIRST_VERSION_LINE - 1)) CHANGELOG.md > temp_changelog.md
                cat new_changelog_entry.md >> temp_changelog.md
                tail -n +$FIRST_VERSION_LINE CHANGELOG.md >> temp_changelog.md
              else
                # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç°æœ‰ç‰ˆæœ¬ï¼ŒæŸ¥æ‰¾æ ‡é¢˜åçš„ä½ç½®
                HEADER_END=$(grep -n "^# " CHANGELOG.md | head -1 | cut -d: -f1)
                if [ -n "$HEADER_END" ]; then
                  # åœ¨æ ‡é¢˜åæ’å…¥
                  head -n $((HEADER_END)) CHANGELOG.md > temp_changelog.md
                  echo "" >> temp_changelog.md
                  cat new_changelog_entry.md >> temp_changelog.md
                  if [ $(wc -l < CHANGELOG.md) -gt $HEADER_END ]; then
                    tail -n +$((HEADER_END + 1)) CHANGELOG.md >> temp_changelog.md
                  fi
                else
                  # å¦‚æœè¿æ ‡é¢˜éƒ½æ²¡æœ‰ï¼Œåˆ›å»ºå®Œæ•´ç»“æ„
                  echo -e "# Change Log\n" > temp_changelog.md
                  cat new_changelog_entry.md >> temp_changelog.md
                  cat CHANGELOG.md >> temp_changelog.md 2>/dev/null || true
                fi
              fi
              mv temp_changelog.md CHANGELOG.md
            fi
          else
            echo "CHANGELOG.md doesn't exist, creating new one"
            echo "# Change Log" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            cat new_changelog_entry.md >> CHANGELOG.md
          fi

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f new_changelog_entry.md extracted-changelog.txt

          echo "CHANGELOG.md updated successfully"

      - name: Commit and push changes
        if: steps.version-check.outputs.version-changed == 'true'
        run: |
          # é…ç½® git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add .

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–éœ€è¦æäº¤
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            NEW_VERSION="${{ steps.version-check.outputs.new-version }}"
            echo "Committing changelog update for version $NEW_VERSION"
            
            git commit -m "docs: update CHANGELOG.md for v$NEW_VERSION"
            
            # å¼ºåˆ¶æ¨é€åˆ° PR åˆ†æ”¯
            echo "Pushing changes to PR branch"
            git push --force-with-lease origin HEAD
          fi

      - name: Add comment to PR
        if: steps.version-check.outputs.version-changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr_number }};
            const newVersion = `${{ steps.version-check.outputs.new-version }}`;
            const forceUpdate = ${{ inputs.force_update }};

            const commentBody = `## ğŸ”„ Changelog Regenerated

            **Version:** \`${newVersion}\`
            **Force update:** ${forceUpdate ? 'âœ… Yes' : 'âŒ No'}

            âœ… CHANGELOG.md has been regenerated with the latest changelog content from this PR description.

            The previous changelog commits (if any) have been removed and replaced with a new commit.

            ---

            ## ğŸ”„ æ›´æ–°æ—¥å¿—å·²é‡æ–°ç”Ÿæˆ

            **ç‰ˆæœ¬ï¼š** \`${newVersion}\`
            **å¼ºåˆ¶æ›´æ–°ï¼š** ${forceUpdate ? 'âœ… æ˜¯' : 'âŒ å¦'}

            âœ… CHANGELOG.md å·²ä½¿ç”¨æ­¤ PR æè¿°ä¸­çš„æœ€æ–°æ›´æ–°æ—¥å¿—å†…å®¹é‡æ–°ç”Ÿæˆã€‚

            ä¹‹å‰çš„æ›´æ–°æ—¥å¿—æäº¤ï¼ˆå¦‚æœ‰ï¼‰å·²è¢«åˆ é™¤å¹¶æ›¿æ¢ä¸ºæ–°çš„æäº¤ã€‚`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: commentBody
            });

      - name: Summary
        if: steps.version-check.outputs.version-changed == 'false'
        run: |
          echo "No version change detected and force update not enabled."
          echo "To update changelog anyway, re-run this workflow with 'force_update' set to true."
