name: Version Check

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  check-version:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Check if package.json version changed
        id: version-check
        run: |
          # è·å– PR ä¸­çš„ç‰ˆæœ¬
          PR_VERSION=$(jq -r .version package.json)
          
          # è·å–åŸºç¡€åˆ†æ”¯çš„ç‰ˆæœ¬
          BASE_VERSION=$(jq -r .version base/package.json)
          
          echo "Base version: $BASE_VERSION"
          echo "PR version: $PR_VERSION"
          
          if [ "$PR_VERSION" != "$BASE_VERSION" ]; then
            echo "âœ… Version changed from $BASE_VERSION to $PR_VERSION"
            echo "ğŸš€ This PR will trigger a release when merged!"
            echo "version-changed=true" >> $GITHUB_OUTPUT
            echo "pr-version=$PR_VERSION" >> $GITHUB_OUTPUT
            echo "base-version=$BASE_VERSION" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Version not changed (still $BASE_VERSION)"
            echo "ğŸ“ This PR will NOT trigger a release when merged"
            echo "version-changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract changelog from PR
        id: extract-changelog
        if: steps.version-check.outputs.version-changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';
            
            console.log('Original PR Body:', prBody);
            
            // å…ˆæ¸…ç†æ•´ä¸ª PR æè¿°ä¸­çš„ HTML æ³¨é‡Š
            const cleanedPrBody = prBody.replace(/<!--[\s\S]*?-->/g, '').trim();
            console.log('PR Body after removing comments:', cleanedPrBody);
            
            // æŸ¥æ‰¾ ## Changelog æˆ– ## æ›´æ–°æ—¥å¿— éƒ¨åˆ†ï¼ˆåœ¨æ¸…ç†åçš„å†…å®¹ä¸­æŸ¥æ‰¾ï¼‰
            const changelogRegex = /(?:^|\n)##\s*(?:Changelog|æ›´æ–°æ—¥å¿—|CHANGELOG)\s*\n([\s\S]*?)(?=\n##|\n---|\n```|$)/i;
            const match = cleanedPrBody.match(changelogRegex);
            
            let changelog = '';
            if (match && match[1]) {
              changelog = match[1].trim();
              console.log('Extracted changelog from ## section:', changelog);
            }
            
            // å¦‚æœæ²¡æœ‰æ‰¾åˆ° changelog éƒ¨åˆ†ï¼Œæ£€æŸ¥æ˜¯å¦æ•´ä¸ª PR æè¿°éƒ½æ˜¯ changelog
            if (!changelog && cleanedPrBody.trim()) {
              // æ£€æŸ¥æ¸…ç†åçš„å†…å®¹æ˜¯å¦åŒ…å«å¸¸è§çš„ changelog å…³é”®è¯
              const changelogKeywords = ['Feature', 'Fixed', 'Changed', 'Added', 'Removed', 'feat', 'fix', 'add', 'update', 'remove', 'æ–°å¢', 'ä¿®å¤', 'æ›´æ–°', 'åˆ é™¤', 'åŠŸèƒ½', 'å˜æ›´'];
              const hasChangelogKeywords = changelogKeywords.some(keyword => 
                cleanedPrBody.toLowerCase().includes(keyword.toLowerCase())
              );
              
              // åªæœ‰åœ¨æ¸…ç†åçš„å†…å®¹æœ‰å®é™…å†…å®¹ä¸”åŒ…å«å…³é”®è¯æ—¶æ‰ä½¿ç”¨
              if (hasChangelogKeywords && cleanedPrBody.length > 0) {
                changelog = cleanedPrBody;
                console.log('Using entire cleaned PR body as changelog');
              }
            }
            
            // æ£€æŸ¥æå–çš„ changelog æ˜¯å¦åªæ˜¯æ¨¡æ¿å†…å®¹
            if (changelog && changelog.trim()) {
              // æ£€æŸ¥æ˜¯å¦åŒ…å«æ¨¡æ¿å…³é”®è¯ï¼Œå¦‚æœæ˜¯æ¨¡æ¿åˆ™æ¸…ç©º
              const templateKeywords = [
                'If this PR requires a new version',
                'å¦‚æœè¿™ä¸ª PR éœ€è¦å‘å¸ƒæ–°ç‰ˆæœ¬',
                'please write the changelog below',
                'è¯·åœ¨ä¸‹é¢å†™æ˜æ›´æ–°æ—¥å¿—',
                'Suggested format',
                'æ ¼å¼å»ºè®®',
                'Example / ç¤ºä¾‹',
                'New feature description',
                'Bug fix description',
                'Feature change description',
                'Removed feature description'
              ];
              
              const isTemplate = templateKeywords.some(keyword => 
                changelog.toLowerCase().includes(keyword.toLowerCase())
              );
              
              if (isTemplate) {
                console.log('Detected template content, clearing changelog');
                changelog = '';
              }
            }
            
            console.log('Final extracted changelog:', changelog);
            
            // è¾“å‡ºåˆ° GitHub Actions
            const fs = require('fs');
            fs.writeFileSync('changelog.txt', changelog);
            
            return { changelog: changelog };

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const versionChanged = '${{ steps.version-check.outputs.version-changed }}' === 'true';
            const prVersion = '${{ steps.version-check.outputs.pr-version }}';
            const baseVersion = '${{ steps.version-check.outputs.base-version }}';
            
            let message;
            if (versionChanged) {
              // è¯»å–æå–çš„ changelog
              const fs = require('fs');
              let changelog = '';
              try {
                changelog = fs.readFileSync('changelog.txt', 'utf8').trim();
              } catch (e) {
                console.log('No changelog file found');
              }
              
              if (changelog) {
                message = `ğŸš€ **Release will be triggered!**\n\nVersion will change from \`${baseVersion}\` to \`${prVersion}\` when this PR is merged.\n\n**ğŸ“ Changelog detected:**\n\n\n${changelog}\n\n\nA new release will be automatically created with tag \`v${prVersion}\` including the above changelog.`;
              } else {
                message = `ğŸš€ **Release will be triggered!**\n\nVersion will change from \`${baseVersion}\` to \`${prVersion}\` when this PR is merged.\n\nâš ï¸ **No changelog detected** in PR description. Consider adding a \`## Changelog\` section to document your changes.\n\n**How to add changelog:**\n1. Edit this PR description\n2. Add a section like this:\nmarkdown\n## Changelog\n\n### Feature\n- New feature description\n\n### Fixed\n- Bug fix description\n\n### Changed\n- Change description\n\n\nA new release will be automatically created with tag \`v${prVersion}\`.`;
              }
            } else {
              message = `ğŸ“ **No release will be triggered**\n\nThe version in \`package.json\` has not been changed (still \`${baseVersion}\`).\n\nTo trigger a release, please update the \`version\` field in \`package.json\`.`;
            }
            
            // æŸ¥æ‰¾å·²å­˜åœ¨çš„è¯„è®º
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              (comment.body.includes('Release will be triggered') || 
               comment.body.includes('No release will be triggered'))
            );
            
            if (botComment) {
              // æ›´æ–°å·²å­˜åœ¨çš„è¯„è®º
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              // åˆ›å»ºæ–°è¯„è®º
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }
